<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal de Servicios - Superintendentes</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="dummyData.js"></script>
  <link rel="stylesheet" href="super.css">  
</head>
<body>
  <div class="container-fluid">
    <div class="row space-nav" align="left">
      <ul class="nav nav-tabs" id="lista">
        <li role="presentation" class="active"><a href="/Supervisores.html">SUPERVISORES</a></li>
        <li role="presentation"><a href="/Inspectores.html">INSPECTORES</a></li>
        <li role="presentation"><a href="/Puestos.html">PUESTOS</a></li>
        <li role="presentation"><a href="/Formatos.html">FORMATOS DE INSP.</a></li>
        <li role="presentation"><a href="/Rubros.html">RUBROS</a></li>                         
      </ul>
    </div>

    <div class="menu-toggle">☰ Menú</div>
    
    <div class="mobile-menu">
      <a href="/Supervisores.html">SUPERVISORES</a>
      <a href="/Inspectores.html">INSPECTORES</a>
      <a href="/Puestos.html">PUESTOS</a>
      <a href="/Formatos.html">FORMATOS DE INSP.</a>
      <a href="/Rubros.html">RUBROS</a>
    </div>

    <div class="row">
      <div class="col-xs-12 col-md-2 filter-group">
        <select id="filterPlanta" class="form-control">
          <option value="" selected>Todos - Plantas</option>
          <option value="Q002-01">IQ NE</option>
          <option value="Q010-01">IQ COATZA</option>
          <option value="Q010-02">IQ TX</option>
          <option value="Q010-03">IQ HM</option>
          <option value="Q083-01">IQ SC</option>
        </select>
      </div>
      
      <div class="col-xs-12 col-md-2 filter-group">
        <input type="text" id="filterSuperintendente" class="form-control" placeholder="Superintendente">
      </div>
      
      <div class="col-xs-12 col-md-2 filter-group">
        <input type="text" id="filterJefe" class="form-control" placeholder="Jefe">
      </div>
      
      <div class="col-xs-12 col-md-2 filter-group">
        <input type="text" id="filterDepartamento" class="form-control" placeholder="Departamento">
      </div>
      
      <div class="col-xs-12 col-md-2 filter-group">
        <input type="text" id="filterTaller" class="form-control" placeholder="Taller"> 
      </div>
    
      <div class="col-xs-12 col-md-2 text-center filter-group">
        <div class="menu-container">
          <button id="showMenu" class="btn btn-primary btn-block">
            <i class="fa fa-cog"></i> Opciones
          </button>
          <ul class="dropdown-menu" id="dropdownMenu">
            <li><a onclick="openModal('superintendenteModal')">Agregar Superintendente</a></li>
            <li><a onclick="openModal('departamentoModal')">Agregar Departamento y Jefe</a></li>
            <li><a onclick="openModal('tallerModal')">Agregar Taller</a></li>
          </ul>
        </div>
      </div>
    </div>
    
    <div id="superintendenteModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('superintendenteModal')">&times;</span>
        <h2>Agregar Superintendente</h2>
        <form id="formSuperintendente">
          <div class="form-group">
            <label for="nombreSuperintendente">Nombre:</label>
            <input type="text" class="form-control" id="nombreSuperintendente" required>
          </div>
          <div class="form-group">
            <label for="plantaSuperintendente">Planta:</label>
            <select class="form-control" id="plantaSuperintendente" required>
              <option value="Q002-01">IQ NE</option>
              <option value="Q010-01">IQ COATZA</option>
              <option value="Q010-02">IQ TX</option>
              <option value="Q010-03">IQ HM</option>
              <option value="Q083-01">IQ SC</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
      </div>
    </div>

    <div id="departamentoModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('departamentoModal')">&times;</span>
        <h2>Agregar Departamento y Jefe</h2>
        <form id="formDepartamento">
          <div class="form-group">
            <label for="superintendenteDept">Superintendente:</label>
            <select class="form-control" id="superintendenteDept" required>
            </select>
          </div>
          <div class="form-group">
            <label for="nombreDepartamento">Nombre del Departamento:</label>
            <input type="text" class="form-control" id="nombreDepartamento" required>
          </div>
          <div class="form-group">
            <label for="nombreJefe">Nombre del Jefe:</label>
            <input type="text" class="form-control" id="nombreJefe" required>
          </div>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
      </div>
    </div>

    <div id="tallerModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('tallerModal')">&times;</span>
        <h2>Agregar Taller</h2>
        <form id="formTaller">
          <div class="form-group">
            <label for="superintendenteTaller">Superintendente:</label>
            <select class="form-control" id="superintendenteTaller" required>
            </select>
          </div>
          <div class="form-group">
            <label for="departamentoTaller">Departamento:</label>
            <select class="form-control" id="departamentoTaller" required>
            </select>
          </div>
          <div class="form-group">
            <label for="nombreTaller">Nombre del Taller:</label>
            <input type="text" class="form-control" id="nombreTaller" required>
          </div>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </form>
      </div>
    </div>
    
    <hr>

    <div id="superintendentesContainer" class="row"></div>
    
  </div>

  <div id="modalTaller" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">Lista de Personas en Taller</h4>
        </div>
        <div class="modal-body">
          <ul id="modalTallerLista" class="list-group"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnAgregarPersonas"><i class="fa fa-plus"></i> Agregar Personas</button>
        </div>
      </div>
    </div>
  </div>


  <div id="modalAgregarPersonas" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">Agregar Personas al Taller</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <input type="text" class="form-control" id="buscarPersona" placeholder="Escriba el nombre de la persona a agregar">
          </div>
          <div id="personasSeleccionadas" class="well well-sm" style="min-height: 50px; margin-top: 15px;">
            <p id="mensajeNoSeleccionados" class="text-muted">No hay personas seleccionadas</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="btnGuardarPersonas">Guardar</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="modalConfirmacion" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title">Confirmar Eliminación</h4>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea eliminar a esta persona del taller?</p>
          <input type="hidden" id="personaEliminar">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let tallerActual = '';
    let superintendenteActual = '';
    function getUniqueValues(data, key) {
      const values = [];
      data.forEach(function(planta) {
        planta.superintendentes.forEach(function(sup) {
          if (!values.includes(sup[key])) {
            values.push(sup[key]);
          }
        });
      });
      return values;
    }

    $(function() {
      $("#filterSuperintendente, #filterJefe, #filterPlanta, #filterDepartamento, #filterTaller").on("input change", function() {
        mostrarTarjetas();  
      });
    
      $("#filterSuperintendente").autocomplete({
        source: function(request, response) {
          const filtered = getUniqueValues(dummyData, 'nombre');
          response(filtered.filter(function(sup) {
            return sup.toLowerCase().includes(request.term.toLowerCase());
          }));
        },
        select: function(event, ui) {
          $(this).val(ui.item.value);
          mostrarTarjetas();
          return false;
        }
      });
    
      $("#filterJefe").autocomplete({
        source: function(request, response) {
          const filtered = [];
          dummyData.forEach(function(planta) {
            planta.superintendentes.forEach(function(sup) {
              sup.departamentos.forEach(function(dept) {
                if (dept.jefe && !filtered.includes(dept.jefe)) {
                  filtered.push(dept.jefe);
                }
              });
            });
          });
          response(filtered.filter(function(jefe) {
            return jefe.toLowerCase().includes(request.term.toLowerCase());
          }));
        },
        select: function(event, ui) {
          $(this).val(ui.item.value);
          mostrarTarjetas();
          return false;
        }
      });
      
      $("#filterDepartamento").autocomplete({
        source: function(request, response) {
          const filtered = [];
          dummyData.forEach(function(planta) {
            planta.superintendentes.forEach(function(sup) {
              sup.departamentos.forEach(function(dept) {
                if (!filtered.includes(dept.nombre)) {
                  filtered.push(dept.nombre);
                }
              });
            });
          });
          response(filtered.filter(function(dept) {
            return dept.toLowerCase().includes(request.term.toLowerCase());
          }));
        },
        select: function(event, ui) {
          $(this).val(ui.item.value);
          mostrarTarjetas();
          return false;
        }
      });
      
      $("#filterTaller").autocomplete({
        source: function(request, response) {
          const filtered = [];
          dummyData.forEach(function(planta) {
            planta.superintendentes.forEach(function(sup) {
              sup.departamentos.forEach(function(dept) {
                Object.keys(dept.talleres).forEach(function(taller) {
                  if (!filtered.includes(taller)) {
                    filtered.push(taller);
                  }
                });
              });
            });
          });
          response(filtered.filter(function(taller) {
            return taller.toLowerCase().includes(request.term.toLowerCase());
          }));
        },
        select: function(event, ui) {
          $(this).val(ui.item.value);
          mostrarTarjetas();
          return false;
        }
      });
    });

    const button = document.getElementById("showMenu");
    const menu = document.getElementById("dropdownMenu");

    button.addEventListener("click", function(event) {
      event.stopPropagation();
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", function(event) {
      if (!menu.contains(event.target) && event.target !== button) {
        menu.style.display = "none";
      }
    });


    function openModal(modalId) {
      document.getElementById(modalId).style.display = "flex";
      menu.style.display = "none";
      
      if (modalId === 'departamentoModal' || modalId === 'tallerModal') {
        const selectSup = document.getElementById(modalId === 'departamentoModal' ? 'superintendenteDept' : 'superintendenteTaller');
        selectSup.innerHTML = '';
        
        dummyData.forEach(planta => {
          planta.superintendentes.forEach(sup => {
            const option = document.createElement('option');
            option.value = sup.nombre;
            option.textContent = `${sup.nombre} (${planta.planta})`;
            selectSup.appendChild(option);
          });
        });
      }
      
      if (modalId === 'tallerModal') {
        document.getElementById('superintendenteTaller').addEventListener('change', function() {
          const supName = this.value;
          const deptSelect = document.getElementById('departamentoTaller');
          deptSelect.innerHTML = '';
          
          dummyData.forEach(planta => {
            planta.superintendentes.forEach(sup => {
              if (sup.nombre === supName) {
                sup.departamentos.forEach(dept => {
                  const option = document.createElement('option');
                  option.value = dept.nombre;
                  option.textContent = dept.nombre;
                  deptSelect.appendChild(option);
                });
              }
            });
          });
        });
        
        document.getElementById('superintendenteTaller').dispatchEvent(new Event('change'));
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function mostrarTarjetas() {
      const container = $("#superintendentesContainer");
      container.empty();
      
      const superintendenteFilter = $("#filterSuperintendente").val().toLowerCase();
      const jefeFilter = $("#filterJefe").val().toLowerCase();
      const departamentoFilter = $("#filterDepartamento").val().toLowerCase();
      const tallerFilter = $("#filterTaller").val().toLowerCase();
      const plantaFilter = $("#filterPlanta").val().toLowerCase();
      
      const superintendentes = {};
      
      dummyData.forEach(function(planta) {
        if (plantaFilter === "" || planta.planta.toLowerCase().includes(plantaFilter)) {
          planta.superintendentes.forEach(function(sup) {
            if (superintendenteFilter === "" || sup.nombre.toLowerCase().includes(superintendenteFilter)) {
              if (!superintendentes[sup.nombre]) {
                superintendentes[sup.nombre] = {
                  nombre: sup.nombre,
                  planta: planta.planta,
                  departamentos: []
                };
              }
              
              sup.departamentos.forEach(function(dept) {
                if ((jefeFilter === "" || dept.jefe.toLowerCase().includes(jefeFilter)) &&
                    (departamentoFilter === "" || dept.nombre.toLowerCase().includes(departamentoFilter))) {
                  
                  const talleresFiltrados = {};
                  let hayTalleresFiltrados = false;
                  
                  Object.keys(dept.talleres).forEach(function(taller) {
                    if (tallerFilter === "" || taller.toLowerCase().includes(tallerFilter)) {
                      talleresFiltrados[taller] = dept.talleres[taller];
                      hayTalleresFiltrados = true;
                    }
                  });
                  
                  if (hayTalleresFiltrados) {
                    superintendentes[sup.nombre].departamentos.push({
                      nombre: dept.nombre,
                      jefe: dept.jefe,
                      talleres: talleresFiltrados
                    });
                  }
                }
              });
            }
          });
        }
      });
      
      const supOrdenados = Object.values(superintendentes);
      
      supOrdenados.forEach(function(sup) {
        if (sup.departamentos.length > 0) {
          const colDiv = $('<div class="col-md-6 "></div>');
          const panelDiv = $('<div class="panel panel-primary superintendente-card"></div>');
          
          const headerDiv = $('<div class="panel-heading"></div>');
          headerDiv.append(`<h3 class="panel-title"><i class="fa fa-user"></i> ${sup.nombre} (${sup.planta})</h3>`);
          panelDiv.append(headerDiv);
          
          const bodyDiv = $('<div class="panel-body"></div>');
          
          sup.departamentos.forEach(function(dept) {
            const deptDiv = $('<div class="departamento-item"></div>');
            deptDiv.append(`<h4>${dept.nombre} <small>Jefe: ${dept.jefe}</small></h4>`);
            
            const talleresDiv = $('<div class="talleres-container"></div>');
            Object.keys(dept.talleres).forEach(function(taller) {
              const tallerBtn = $(`<span class="label label-info taller-badge"> <i class="fa fa-eye"></i> ${taller}</span>`);
              tallerBtn.on('click', function() {

                verModal(taller, sup.nombre);
              });
              talleresDiv.append(tallerBtn);
            });
            
            deptDiv.append(talleresDiv);
            bodyDiv.append(deptDiv);
          });
          
          panelDiv.append(bodyDiv);
          colDiv.append(panelDiv);
          container.append(colDiv);
        }
      });
      
      if (supOrdenados.length === 0) {
        container.append('<div class="col-xs-12 text-center"><h4>No se encontraron resultados con los filtros seleccionados</h4></div>');
      }
    }
      
    function verModal(taller, superintendente) {
      const modalLista = $("#modalTallerLista");
      modalLista.empty();
      tallerActual = taller;
      console.log(tallerActual, "ejemplo")
      superintendenteActual = superintendente;
      $('.modal-title').text(`Personal del Taller: ${taller}`);
  
      dummyData.forEach(function(planta) {
        planta.superintendentes.forEach(function(sup) {
          if (sup.nombre === superintendente) {
            sup.departamentos.forEach(function(dept) {
              if (dept.talleres[taller]) {
                const personas = dept.talleres[taller].supervisores;
                console.log(personas)
                personas.forEach(function(persona) {
                  const btnEliminar = $('<button class="btn btn-danger btn-xs pull-right"><i class="fa fa-trash"></i> Eliminar</button>');
                  btnEliminar.on('click', function() {
                    mostrarConfirmacionEliminar(persona.nombre);
                  });
                  
                  const listItem = $('<li class="list-group-item"></li>');
                  listItem.text(persona.nombre);
                  listItem.append(btnEliminar);
                  modalLista.append(listItem);
                });
              }
            });
          }
        });
      });
  
      $('#modalTaller').modal('show');
    }

    // Checar pq no se elimina
    function mostrarConfirmacionEliminar(persona) {
      console.log(persona)
      $('#personaEliminar').val(persona);
      $('#modalTaller').modal('hide');
      $('#modalConfirmacion').modal('show');
    }
  
    function eliminarPersona(persona) {
      let eliminada = false;
      
      dummyData.forEach(function(planta) {
        planta.superintendentes.forEach(function(sup) {
          if (sup.nombre === superintendenteActual) {
            sup.departamentos.forEach(function(dept) {
              if (dept.talleres[tallerActual]) { 
                const index = dept.talleres[tallerActual].supervisores.indexOf(persona);
                if (index > -1) {
                  dept.talleres[tallerActual].supervisores.splice(index, 1);
                  eliminada = true;
                }
              }
            });
          }
        });
      });
      
      $('#modalConfirmacion').modal('hide');
      
      if (eliminada) {
        alert(`Se ha eliminado a ${persona} del taller ${tallerActual}`);
      } else {
        alert('No se pudo eliminar a la persona seleccionada');
      }
      
      verModal(tallerActual, superintendenteActual);
    }
    
    function mostrarModalAgregarPersonas() {
      $('#mensajeNoSeleccionados').show();
      $('#personasSeleccionadas').find('.persona-tag').remove();
      $('#modalTaller').modal('hide');
      $('#modalAgregarPersonas').modal('show');
    }
  
    function agregarPersonaSeleccionada(nombre) {
      $('#mensajeNoSeleccionados').hide();
      
      if ($('#personasSeleccionadas').find(`[data-nombre="${nombre}"]`).length > 0) {
        alert('¡Esta persona ya está seleccionada!');
        return;
      }

      let yaEnTaller = false;
      dummyData.forEach(function(planta) {
        planta.superintendentes.forEach(function(sup) {
          sup.departamentos.forEach(function(dept) {
            Object.values(dept.talleres).forEach(function(taller) {
              taller.supervisores.forEach(function(sup) {
                if (sup.nombre === nombre) {
                  yaEnTaller = true;
                  return;
                }
              });
            });
          });
        });
      })
      
      if (yaEnTaller) {
        alert(`¡${nombre} ya pertenece a este taller!`);
        return;
      }
      
      const personaTag = $(`
        <div class="persona-tag label label-info" data-nombre="${nombre}" style="display: inline-block; margin: 5px; padding: 8px; font-size: 14px;">
          ${nombre}
          <button type="button" class="close" style="float: none; margin-left: 5px; opacity: 0.7;">&times;</button>
        </div>
      `);
      
      personaTag.find('.close').on('click', function() {
        personaTag.remove();
        if ($('#personasSeleccionadas').find('.persona-tag').length === 0) {
          $('#mensajeNoSeleccionados').show();
        }
      });
      
      $('#personasSeleccionadas').append(personaTag);
    }
  
    function guardarPersonasSeleccionadas() {
      const nuevasPersonas = [];
      $('#personasSeleccionadas').find('.persona-tag').each(function() {
        nuevasPersonas.push($(this).data('nombre'));
      });
      
      if (nuevasPersonas.length === 0) {
        alert('No hay personas seleccionadas para agregar');
        return;
      }
      
      let personasAgregadas = 0;
      dummyData.forEach(function(planta) {
        planta.superintendentes.forEach(function(sup) {
          if (sup.nombre === superintendenteActual) {
            sup.departamentos.forEach(function(dept) {
              if (dept.talleres[tallerActual]) {
                nuevasPersonas.forEach(function(persona) {
                  console.log(persona)
                  if (!dept.talleres[tallerActual].supervisores.includes(persona)) {
                    dept.talleres[tallerActual].supervisores.push({ nombre: persona, inspectores: []});
                    personasAgregadas++;
                  }
                });
              }
            });
          }
        });
      });
      
      $('#modalAgregarPersonas').modal('hide');
      
      if (personasAgregadas > 0) {
        alert(`Se han agregado ${personasAgregadas} persona(s) al taller ${tallerActual}`);
      } else {
        alert('No se agregaron nuevas personas, posiblemente ya estaban en el taller');
      }
      
      verModal(tallerActual, superintendenteActual);
    }


    $(document).ready(function() {
      $(".menu-toggle").click(function() {
        $(".mobile-menu").slideToggle();
      });

      $('#formSuperintendente').on('submit', function(e) {
        e.preventDefault();
        alert('Superintendente agregado correctamente');
        closeModal('superintendenteModal');
      });
      
      $('#formDepartamento').on('submit', function(e) {
        e.preventDefault();
        alert('Departamento agregado correctamente');
        closeModal('departamentoModal');
      });
      
      $('#formTaller').on('submit', function(e) {
        e.preventDefault();
        alert('Taller agregado correctamente');
        closeModal('tallerModal');
      });

      $("#buscarPersona").autocomplete({
        source: personasDisponibles,
        minLength: 0,  
        select: function(event, ui) {
          agregarPersonaSeleccionada(ui.item.value);
          $(this).val('');
          return false;
        }
      }).focus(function() {
        $(this).autocomplete("search", "");
      });

      $("#buscarPersona").autocomplete({
        source: function(request, response) {
          let personasEnTaller = [];
          dummyData.forEach(function(planta) {
            planta.superintendentes.forEach(function(sup) {
              if (sup.nombre === superintendenteActual) {
                sup.departamentos.forEach(function(dept) {
                  if (dept.talleres[tallerActual]) {
                    personasEnTaller = dept.talleres[tallerActual].supervisores;
                  }
                });
              }
            });
          });
          const personasFiltradas = personasDisponibles.filter(function(persona) {
            return !personasEnTaller.includes(persona) && 
              (request.term === "" || persona.toLowerCase().includes(request.term.toLowerCase()));
          });
          
          response(personasFiltradas);
        },
        minLength: 0,
        select: function(event, ui) {
          agregarPersonaSeleccionada(ui.item.value);
          $(this).val('');
          return false;
        }
      }).focus(function() {
        $(this).autocomplete("search", "");
      });

      $('#btnAgregarPersonas').on('click', mostrarModalAgregarPersonas);
      $('#btnGuardarPersonas').on('click', guardarPersonasSeleccionadas);
      $('#btnConfirmarEliminar').on('click', function() {
        eliminarPersona($('#personaEliminar').val());
      });

      mostrarTarjetas();
    });
  </script>
</body>
</html>